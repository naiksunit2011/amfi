<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <style>
      * {
        font-family: -webkit-pictograph;
        font-size: 30px;
      }

      body {
        background-color: black;
        color: white;
      }

      #totalChangeAmt {
        text-align: center;
        font-size: 70px;
        padding: 25px;
      }

      .gain{
        color: chartreuse;
      }

      .loss{
        color: firebrick;
      }

      table {
        margin-left: auto;
        margin-right: auto;
        width: 90%;
      }

      .table-header {
        height: 40px;
        color: darkviolet;
      }

      .col-right {
        text-align: right;
      }

      .col-left {
        text-align: left;
      }
    </style>
    <script>
      let SERVICE_CACHE = "serviceCacheData";
      let serviceArr = [];
      let amountArr = [];
      addServiceData("https://www.moneycontrol.com/mutual-funds/axis-small-cap-fund-direct-plan/portfolio-holdings/MAA316",500);
      addServiceData("https://www.moneycontrol.com/mutual-funds/pgim-india-flexi-cap-fund-direct-plan/portfolio-holdings/MPA159",1000);
      addServiceData("https://www.moneycontrol.com/mutual-funds/kotak-small-cap-fund-direct-plan/portfolio-holdings/MKM516",5000);
      addServiceData("https://www.moneycontrol.com/mutual-funds/tata-digital-india-fund-direct-plan/portfolio-holdings/MTA1147",500);
      addServiceData("https://www.moneycontrol.com/mutual-funds/pgim-india-midcap-opportunities-fund-direct-plan/portfolio-holdings/MPA139",1000);
      addServiceData("https://www.moneycontrol.com/mutual-funds/nippon-india-small-cap-fund-direct-plan/portfolio-holdings/MRC935",1000);
      addServiceData("https://www.moneycontrol.com/mutual-funds/quant-small-cap-fund-direct-plan/portfolio-holdings/MES056",5100);
      addServiceData("https://www.moneycontrol.com/mutual-funds/mirae-asset-emerging-bluechip-fund-direct-plan/portfolio-holdings/MMA100",17499);
      addServiceData("https://www.moneycontrol.com/mutual-funds/icici-prudential-technology-fund-direct-plan/portfolio-holdings/MPI1128",5000);
      addServiceData("https://www.moneycontrol.com/mutual-funds/quant-active-fund-direct-plan/portfolio-holdings/MES061",1000);
      addServiceData("https://www.moneycontrol.com/mutual-funds/quant-infrastructure-fund-direct-plan/portfolio-holdings/MES051",1000);
      // addServiceData("https://www.moneycontrol.com/mutual-funds/parag-parikh-flexi-cap-fund-direct-plan/portfolio-holdings/MPP002",0);
      // addServiceData("https://www.moneycontrol.com/mutual-funds/nippon-india-pharma-fund-direct-plan/portfolio-holdings/MRC1005",0);

      let resultJson = {};
      let amountJson = {};
      
      let cacheTimeout = 600000;
      let serviceCache = getServiceCache();

      function init() {
        for (let index = 0; index < serviceArr.length; index++) {
          const portfolioUrl = serviceArr[index];
          callService(portfolioUrl, (responseText) => {
            processMutualFund(getFundName(portfolioUrl), responseText, amountArr[index]);
          });
        }
      }

      function addServiceData(link,amount){
        serviceArr.push(link);
        amountArr.push(amount);
      }

      function getNavUrl(portfolioUrl) {
        return portfolioUrl.replace("/mutual-funds/", "/mutual-funds/nav/").replace("/portfolio-holdings/", "/");
      }

      function getFundName(portfolioUrl) {
        return titleCase(portfolioUrl.replace("https://www.moneycontrol.com/mutual-funds/", "").split("/")[0].replace(/-/g, " "));
      }

      function titleCase(str) {
        let splitStr = str.toLowerCase().split(" ");
        for (let i = 0; i < splitStr.length; i++) {
          splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].substring(1);
        }
        return splitStr.join(" ");
      }

      function callService(url, callbackFunction) {
        let xmlhttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
        xmlhttp.onreadystatechange = () => {
          if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            if (callbackFunction) {
              callbackFunction(xmlhttp.responseText);
            }
            return xmlhttp.responseText;
          }
        };
        xmlhttp.open("GET", url, true);
        xmlhttp.send();
      }

      function getExpenseRation(expenseRationResponseText) {
        return parseFloat(getParsedDom(expenseRationResponseText).querySelector(".navdetails tr:nth-child(1) td:nth-child(2) .amt")?.textContent?.replace("%", "")) * 0.01;
      }

      function processMutualFund(fundName, htmlString, fundAmount) {
        amountJson[fundName] = fundAmount;
        let currentPercentageChange = 0;
        getParsedDom(htmlString)
          .querySelectorAll("#equityCompleteHoldingTable tbody tr")
          .forEach((row, index, array) => {
            let name = row.querySelector("td:nth-child(1)")?.textContent?.replace(/\n/g, "")?.replace(/#/g, "")?.replace(/-/g, "")?.trim();
            let holdingPercentage = parseFloat(row.querySelector("td:nth-child(5)")?.textContent?.replace(/\n/g, "").replace("%", ""));
            let stockHref = row.querySelector("td:nth-child(1) a")?.href;
            let stockLink = "https://priceapi.moneycontrol.com/pricefeed/nse/equitycash/" + stockHref.split("/").pop();

            getCurrentStockChange(stockLink, (pricepercentchange) => {
              currentPercentageChange += holdingPercentage * 0.01 * parseFloat(pricepercentchange);
              resultJson[fundName] = currentPercentageChange.toFixed(2);
              renderResult();
            });
          });
      }

      function getParsedDom(htmlString) {
        return new DOMParser().parseFromString(htmlString, "text/html");
      }

      function renderResult() {
        let tableRow = "";
        let nameArr = Object.keys(resultJson);
        let totalChangeAmt = 0;
        for (let index = 0; index < nameArr.length; index++) {
          const name = nameArr[index];
          const currentPercentageChange = resultJson[name];
          const amount = amountJson[name];
          let modifiedName = name.replace(" Fund Direct Plan", "").replace("Icici", "ICICI").replace("Pgim", "PGIM");
          let changeAmt = parseFloat(currentPercentageChange*amount*0.01);
          totalChangeAmt += changeAmt;
          tableRow += `<tr>
              <td class="col-left">
                ${modifiedName}
              </td>
              <td class="col-right">
                ${currentPercentageChange}
              </td>
              <td class="col-right">
                ${amount}
              </td>
              <td class="col-right">
                ${changeAmt.toFixed(2)}
              </td>
            </tr>`;
        }
        let amtClass = (totalChangeAmt > 0)?"gain":"loss";
        let table = `<div id="totalChangeAmt" class="${amtClass}">Today's Change : â‚¹. ${totalChangeAmt.toFixed(2)}</div>
        <table>
          <tr class="table-header">
            <th class="col-left">Mutual Fund Name</th>
            <th class="col-right">Change %</th>
            <th class="col-right">Invested</th>
            <th class="col-right">Gain/Loss</th>
          </tr>
          ${tableRow}
          </table>`;
        document.getElementById("result").innerHTML = table;
        const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

        const comparer = (idx, asc) => (a, b) =>
          ((v1, v2) => (v1 !== "" && v2 !== "" && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)))(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

        document.querySelectorAll("th").forEach((th) =>
          th.addEventListener("click", () => {
            const table = th.closest("table");
            Array.from(table.querySelectorAll("tr:nth-child(n+2)"))
              .sort(comparer(Array.from(th.parentNode.children).indexOf(th), (this.asc = !this.asc)))
              .forEach((tr) => table.appendChild(tr));
          })
        );
      }

      function getCurrentStockChange(stockLink, callbackFunction) {
        let currentTime = new Date().getTime();
        let data = serviceCache?.[stockLink]?.data;
        let time = serviceCache?.[stockLink]?.time;
        let timeDiff = currentTime - time;
        if (data && timeDiff < cacheTimeout) {
          if (callbackFunction) {
            callbackFunction(serviceCache?.[stockLink]?.data);
          }
        } else {
          callService(stockLink, (responseText) => {
            let resp = JSON.parse(responseText);
            let data = "0";
            if (resp.code == 200 && resp.data) {
              if (callbackFunction) {
                callbackFunction(resp.data.pricepercentchange);
                data = resp.data.pricepercentchange;
              }
            }
            serviceCache[stockLink] = { time: currentTime, data: data };
            setServiceCache(serviceCache);
          });
        }
      }

      function getServiceCache() {
        return JSON.parse(localStorage.getItem(SERVICE_CACHE) || "{}");
      }

      function setServiceCache(serviceCache) {
        localStorage.setItem(SERVICE_CACHE, JSON.stringify(serviceCache));
      }

      init();
    </script>
  </head>

  <body>
    <div id="result"></div>
  </body>
</html>
