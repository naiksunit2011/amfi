<!DOCTYPE html>
<html>
  <head>
    <style>
      #result {
        font-size: 30px;
        font-family: -webkit-pictograph;
      }
      table {
        margin-left: auto;
        margin-right: auto;
        width: 90%;
      }
      .table-header {
        height: 40px;
      }
      .col-right {
        text-align: right;
      }
      .col-left {
        text-align: left;
      }
    </style>
    <script>
      let serviceArr = [];
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/quant-small-cap-fund-direct-plan/portfolio-holdings/MES056");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/icici-prudential-technology-fund-direct-plan/portfolio-holdings/MPI1128");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/kotak-small-cap-fund-direct-plan/portfolio-holdings/MKM516");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/mirae-asset-emerging-bluechip-fund-direct-plan/portfolio-holdings/MMA100");

      serviceArr.push("https://www.moneycontrol.com/mutual-funds/tata-digital-india-fund-direct-plan/portfolio-holdings/MTA1147");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/pgim-india-flexi-cap-fund-direct-plan/portfolio-holdings/MPA159");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/nippon-india-small-cap-fund-direct-plan/portfolio-holdings/MRC935");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/quant-active-fund-direct-plan/portfolio-holdings/MES061");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/mirae-asset-emerging-bluechip-fund-direct-plan/portfolio-holdings/MMA100");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/axis-small-cap-fund-direct-plan/portfolio-holdings/MAA316");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/parag-parikh-flexi-cap-fund-direct-plan/portfolio-holdings/MPP002");
      serviceArr.push("https://www.moneycontrol.com/mutual-funds/nippon-india-pharma-fund-direct-plan/portfolio-holdings/MRC1005");

      let resultJson = {};
      let cacheTimeout = 900000;
      let serviceCacheName = "serviceCacheData";
      let serviceCache = getServiceCache();

      function init() {
        for (let index = 0; index < serviceArr.length; index++) {
          const portfolioUrl = serviceArr[index];
          const navUrl = getNavUrl(portfolioUrl);
          callService(portfolioUrl, (responseText) => {
            document.addEventListener("DOMContentLoaded", (event) => {
              processMutualFund(getFundName(portfolioUrl), responseText);
            });
          });
        }
      }

      function getNavUrl(portfolioUrl) {
        return portfolioUrl.replace("/mutual-funds/", "/mutual-funds/nav/").replace("/portfolio-holdings/", "/");
      }

      function getFundName(portfolioUrl) {
        return titleCase(portfolioUrl.replace("https://www.moneycontrol.com/mutual-funds/", "").split("/")[0].replace(/-/g, " "));
      }

      function titleCase(str) {
        let splitStr = str.toLowerCase().split(" ");
        for (let i = 0; i < splitStr.length; i++) {
          splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].substring(1);
        }
        return splitStr.join(" ");
      }

      function callService(portfolioUrl, callbackFunction) {
        let xmlhttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
        xmlhttp.onreadystatechange = () => {
          if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            if (callbackFunction) {
              callbackFunction(xmlhttp.responseText);
            }
            return xmlhttp.responseText;
          }
        };
        xmlhttp.open("GET", portfolioUrl, false);
        xmlhttp.send();
      }

      function getExpenseRation(expenseRationResponseText) {
        return parseFloat(getParsedDom(expenseRationResponseText).querySelector(".navdetails tr:nth-child(1) td:nth-child(2) .amt")?.textContent?.replace("%", "")) * 0.01;
      }

      function processMutualFund(fundName, htmlString) {
        let currentPercentageChange = 0;
        getParsedDom(htmlString)
          .querySelectorAll("#equityCompleteHoldingTable tbody tr")
          .forEach((row, index, array) => {
            let name = row.querySelector("td:nth-child(1)")?.textContent?.replace(/\n/g, "")?.replace(/#/g, "")?.replace(/-/g, "")?.trim();
            let holdingPercentage = parseFloat(row.querySelector("td:nth-child(5)")?.textContent?.replace(/\n/g, "").replace("%", ""));
            let stockHref = row.querySelector("td:nth-child(1) a")?.href;
            let stockLink = "https://priceapi.moneycontrol.com/pricefeed/nse/equitycash/" + stockHref.split("/").pop();

            getCurrentStockChange(stockLink, (pricepercentchange) => {
              currentPercentageChange += holdingPercentage * 0.01 * parseFloat(pricepercentchange);
              resultJson[fundName] = currentPercentageChange.toFixed(2);
              renderResult();
            });
          });
      }

      function getParsedDom(htmlString) {
        return new DOMParser().parseFromString(htmlString, "text/html");
      }

      function renderResult() {
        let tableRow = "";
        let nameArr = Object.keys(resultJson);
        for (let index = 0; index < nameArr.length; index++) {
          const name = nameArr[index];
          const currentPercentageChange = resultJson[name];
          tableRow += `<tr><td class="col-left">${name}</td><td class="col-right">${currentPercentageChange}</td></tr>`;
        }
        let table = `<table><tr class="table-header"><th class="col-left">Mutual Fund Name</th><th class="col-right">Change %</th></tr>${tableRow}</table>`;
        document.getElementById("result").innerHTML = table;
      }

      function getCurrentStockChange(stockLink, callbackFunction) {
        let currentTime = new Date().getTime();
        let data = serviceCache?.[stockLink]?.data;
        let time = serviceCache?.[stockLink]?.time;
        let timeDiff = currentTime - time;
        if (data && timeDiff < cacheTimeout) {
          if (callbackFunction) {
            callbackFunction(serviceCache?.[stockLink]?.data);
          }
        } else {
          callService(stockLink, (responseText) => {
            let resp = JSON.parse(responseText);
            let data = "0";
            if (resp.code == 200 && resp.data) {
              if (callbackFunction) {
                callbackFunction(resp.data.pricepercentchange);
                data = resp.data.pricepercentchange;
              }
            }
            serviceCache[stockLink] = { time: currentTime, data: data };
            setServiceCache(serviceCache);
          });
        }
      }

      function getServiceCache() {
        return JSON.parse(localStorage.getItem(serviceCacheName) || "{}");
      }

      function setServiceCache(serviceCache) {
        localStorage.setItem(serviceCacheName, JSON.stringify(serviceCache));
      }

      init();
    </script>
  </head>
  <body>
    <pre>
      <div id="result"></div>
    </pre>
  </body>
</html>
